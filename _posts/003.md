---
title: '学祭に向けて人数カウンタを作った話'
excerpt: ''
coverImage: '/assets/blog/003/thumbnail.png'
date: '2023-11-6'
ogImage:
  url: '/assets/blog/dynamic-routing/cover.jpg'
tags:
  - '開発'
---

## 学祭に向けて人数カウンタを作った話
大阪大学の学祭実行委員会のMaltonです。  
さて、弊委員会では毎年の学祭で来場者のカウントをする「カウント係」を入り口付近に配置していたのですが、自動化できないかという相談を受けたので、作ってみることにしました。

## TL;DR
YoLo + BoTSORTでカメラ映像から前を通る人数のカウントをしたよ。
コードは[Github](https://github.com/maltonn/human-counting)で公開してるよ

## タスクと技術選定
メインストリートにカメラを1台置き、その映像のみから人数をカウントします。   
![image](/assets/blog/003/1.png)
（開発デバッグ用の映像 / 協力してくれた方ありがとうございました）

真上からカメラをつるすのは許されず、サーモカメラなどの人の輪郭をとらえやすいカメラも貸し出し許可が下りず、結局普通のカメラを使うことになりました。  また、基本的に複数人が固まって前を通ることを考えると古典的な画像処理だと一筋縄ではいかなさそう....というわけで深層学習ベースの認識手法に舵を切りました。  （偶然にも部内で使ってよいゲーミングノートPCが見つかったことも大きい）  

### 認識部分
hugging faceで「human count」「human recognition」とかで検索するもあんまりよい感じのものは見つからず、素直に万能認識モデルを使うことにしました。今回採用したのは[yolos-tiny](https://huggingface.co/hustvl/yolos-tiny)です。（これより大きいモデルはGPU1台ではかなり厳しそうだった）

サンプルコードコピペして適当に編集したところ、（ややフレームレートに懸念点は残るものの）それなりにうまくいきました。
![image](/assets/blog/003/2.png)

### カウント部分
認識さえできればあとは単純なアルゴリズムでカウントもできるやろ！と踏んでいたのですが思ったよりつらそう。調べてみると、このタスクにSORT（Simple Online and Realtime Tracking）という名前がちゃんとついており、それ専用の研究も進んでいるようです。  
というわけでそれっぽいものを見つけてきて上で実装したものにくっつけました。今回採用したのは[boxmot](https://pypi.org/project/boxmot/)です。pipで入るのが嬉しい。

あとは、「トラッキングのIDを見て、今までになさそうならテキストファイルにタイムスタンプを追加」みたいな処理を書いて完成しました。


### 表示部分
ボスに「途中結果を見れるようにしてね♡」と言われたので、表示部分を作ります。  
#### サーバー
Flaskで立てて、リクエストに対して今までのカウント情報（カメラの前を人が時のタイムスタンプ）を送ります。  
#### クライアント
10秒おきにfetchしてかえってきたタイムスタンプのリストをうまいことやって表に落とし込みます。（8割くらいcopilotとchatGPTに任せました）  
#### ホスティング
めんどくさかった&どうせ内部の人間しか見ないのでlocalhostで建てたものをngrokでトンネリングしました。

## 実践投入！
なんか書く